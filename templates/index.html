<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EarnQuick BD</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* (‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶®‡ßç‡¶®‡¶§ CSS ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá - ‡¶Ø‡¶æ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá) */
        /* --- CSS ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ --- */
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background-color: #f7f9fc; color: #333; }
        .marquee-container { background-color: #4a00e0; color: white; padding: 8px 0; overflow: hidden; white-space: nowrap; margin-bottom: 10px; font-size: 14px; font-weight: 600; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); margin: 10px 20px; transition: all 0.3s ease; }
        .card h3 { color: #4a00e0; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 0; }
        .balance-info { font-size: 38px; font-weight: 900; color: #28a745; margin-bottom: 5px; }
        input, select, button { width: 100%; padding: 12px; margin-top: 8px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ddd; font-family: 'Poppins', sans-serif; }
        button#watchAdButton { padding: 15px 20px; font-size: 18px; font-weight: 700; background: linear-gradient(45deg, #007bff, #00c6ff); color: white; cursor: pointer; border: none; margin-top: 20px; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4); }
        #withdrawSection button { background: linear-gradient(45deg, #dc3545, #fd7e14); box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3); }
        button:disabled { background-color: #ccc !important; box-shadow: none; cursor: not-allowed; background: none !important; color: #666;}
        /* --- CSS ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶∂‡ßá‡¶∑ --- */
    </style>
    
    <script src='//libtl.com/sdk.js' data-zone='{{ monetag_zone_id }}' data-sdk='show_{{ monetag_zone_id }}'></script>
</head>
<body>
    
    <div class="marquee-container">
        <marquee behavior="scroll" direction="left"><span id="runningHeadline">{{ headline }}</span></marquee>
    </div>

    <div class="card">
        <h3>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ üí∞</h3>
        <p class="balance-info"><span id="currentBalance">...</span> ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</p>
        <p>‡¶ü‡¶æ‡¶ï‡¶æ: ‡ß≥ <span id="currentBdt">0.00</span></p>
        <p class="task-limit">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡ßÄ‡¶Æ‡¶æ: <span id="currentTasks">‡ß¶</span>/‡ß©‡ß¶</p>
        <p style="color: green;">‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶®‡ßá: <span id="rewardPoints"></span> ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü</p>
    </div>
    
    <div class="card">
        <h3>‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® üì∫</h3>
        <p id="adMessage" style="color: red;"></p>
        <button id="watchAdButton" onclick="watchAdAndGrantReward()">‚ñ∂Ô∏è ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
    </div>

    <div class="card" id="withdrawSection">
        <h3>‡¶ü‡¶æ‡¶ï‡¶æ ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶® (Withdraw) üí∏</h3>
        <p>‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞: **<span id="minWithdrawPoints"></span>** ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü (‡ß≥ <span id="minWithdrawBDT"></span>)</p>
        
        <label for="withdrawPoints">‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü:</label>
        <input type="number" id="withdrawPoints" placeholder="‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶®" min="" required>
        
        <label for="paymentMethod">‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ:</label>
        <select id="paymentMethod">
            <option value="bKash">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option>
            <option value="Nagad">‡¶®‡¶ó‡¶¶</option>
            <option value="Rocket">‡¶∞‡¶ï‡ßá‡¶ü</option>
        </select>
        
        <label for="accountNumber">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</label>
        <input type="text" id="accountNumber" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" required>
        
        <button onclick="requestWithdrawal()">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
        <p id="withdrawStatus" style="margin-top: 10px;"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', loadUserData);
        
        // Python ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶è‡¶®‡ßç‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
        const POINTS_PER_BDT = {{ points_per_bdt }};
        const MIN_WITHDRAW_POINTS = {{ min_withdraw_points }};
        const AD_REWARD_POINTS = {{ ad_reward_points }};
        const ZONE_ID = '{{ monetag_zone_id }}';
        
        // --- ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç (Monetag ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡¶∞‡¶ø‡¶π‡¶æ‡¶∞‡ßç‡¶Ø) ---
        let user_id = 123; // Fallback ID 
        if (typeof Telegram !== 'undefined' && Telegram.WebApp.initDataUnsafe.user) {
            user_id = Telegram.WebApp.initDataUnsafe.user.id;
        }

        // UI ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        document.getElementById('rewardPoints').textContent = AD_REWARD_POINTS;
        document.getElementById('minWithdrawPoints').textContent = MIN_WITHDRAW_POINTS;
        document.getElementById('minWithdrawBDT').textContent = (MIN_WITHDRAW_POINTS / POINTS_PER_BDT).toFixed(2);
        document.getElementById('withdrawPoints').min = MIN_WITHDRAW_POINTS;
        
        // Monetag Ad Handler Lgoc
        // ‡¶Ø‡¶¶‡¶ø Monetag SDK ‡¶≤‡ßã‡¶° ‡¶®‡¶æ ‡¶π‡¶Ø‡¶º (‡¶Ø‡ßá‡¶Æ‡¶® adHandler ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® undefined ‡¶π‡¶Ø‡¶º), 
        // ‡¶§‡¶¨‡ßá ‡¶è‡¶ü‡¶ø ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶è‡¶°‡¶º‡¶æ‡¶§‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶°‡¶æ‡¶Æ‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá‡•§
        const adHandler = typeof createAdHandler === 'function' ? createAdHandler(ZONE_ID) : async () => { 
            console.warn("Monetag SDK (createAdHandler) not found, using dummy ad handler.");
            await new Promise(resolve => setTimeout(resolve, 1000)); // 1s wait simulation
        }; 
        
        // --- ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ---

        async function loadUserData() {
            try {
                const response = await fetch(`/api/user_data?user_id=${user_id}`);
                const data = await response.json();
                
                if (data.success) {
                    const balance = parseFloat(data.balance);
                    document.getElementById('currentBalance').textContent = Math.round(balance);
                    document.getElementById('currentBdt').textContent = (balance / POINTS_PER_BDT).toFixed(2); 
                    document.getElementById('currentTasks').textContent = data.tasks_completed;
                } else {
                    // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¨‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶≤‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
                    document.getElementById('adMessage').textContent = '‚ö†Ô∏è ' + data.message;
                }
            } catch (error) {
                document.getElementById('adMessage').textContent = '‚ùå ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§';
            }
        }

        async function handleAdComplete() {
            const response = await fetch('/api/watch_ad', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: user_id }) 
            });
            return await response.json();
        }

        async function watchAdAndGrantReward() {
            const button = document.getElementById('watchAdButton');
            const messageElement = document.getElementById('adMessage');
            
            button.disabled = true;
            messageElement.textContent = '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
            
            try {
                // adHandler ‡¶ï‡¶≤
                await adHandler(); 
                messageElement.textContent = '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶∏‡¶´‡¶≤! ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
                
                const result = await handleAdComplete();
                
                if (result.success) {
                    messageElement.textContent = result.message + (result.commission_added > 0 ? ` (+${(result.commission_added).toFixed(2)} ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®)` : '');
                    loadUserData(); 
                } else {
                    messageElement.textContent = '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ' + result.message;
                }
                
            } catch (error) {
                messageElement.textContent = '‚ùå ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶¨‡¶æ ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§';
            } finally {
                button.disabled = false;
            }
        }

        async function requestWithdrawal() {
            const points = parseInt(document.getElementById('withdrawPoints').value);
            const method = document.getElementById('paymentMethod').value;
            const account = document.getElementById('accountNumber').value;
            const statusElement = document.getElementById('withdrawStatus');
            
            if (points < MIN_WITHDRAW_POINTS || isNaN(points)) {
                statusElement.textContent = `‚ùå ‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∏‡ßÄ‡¶Æ‡¶æ ${MIN_WITHDRAW_POINTS} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡•§`;
                return;
            }
            if (!account) {
                statusElement.textContent = `‚ùå ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§`;
                return;
            }
            
            try {
                const response = await fetch('/api/request_withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: user_id, amount_points: points, method: method, account_number: account })
                });
                const data = await response.json();
                
                statusElement.textContent = data.success ? `‚úÖ ${data.message}` : `‚ùå ${data.message}`;
                if (data.success) loadUserData();
                
            } catch (error) {
                statusElement.textContent = '‚ùå ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡•§';
            }
        }
    </script>
</body>
</html>
